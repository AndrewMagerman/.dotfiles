#!/bin/bash
set -euxo pipefail

if command -v nvim >/dev/null 2>&1; then
  echo "✔️ Neovim already installed: $(nvim --version | head -n 1)"
  exit 0
fi

echo "📦 Installing Neovim build dependencies..."
sudo apt-get update
sudo apt-get install -y \
  ninja-build gettext cmake unzip curl build-essential git

echo "🛠️ Cloning Neovim source..."
git clone --depth=1 https://github.com/neovim/neovim.git "$HOME/neovim"
cd "$HOME/neovim"

echo "🏗️ Building Neovim..."
make CMAKE_BUILD_TYPE=RelWithDebInfo

echo "🚀 Installing Neovim into ~/.local..."
make install PREFIX="$HOME/.local"

echo "🧹 Cleaning up..."
rm -rf "$HOME/neovim"

# Add to PATH (if not already handled in your dotfiles)
if ! echo "$PATH" | grep -q "$HOME/.local/bin"; then
  echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.profile"
  export PATH="$HOME/.local/bin:$PATH"
fi

echo "✅ Neovim installed: $(nvim --version | head -n 1)"

